# CR-CODEX — Repo Quality Review

> **Ceremony Type:** Code Review (CR) — Codex-Assisted  
> **Status:** In-progress (actionable)  
> **Date:** 2025-12-28  
> **Reviewer:** Codex  
> **Repo:** inkswarm-detectlab  
> **Branch/Commit:** main (snapshot)  
> **Scope Window:** Entire repo  
> **Non-Goals:** Implementation of fixes (tracking only)

---

## 0) Purpose

A five-step Codex-driven repo quality review with explicit follow-up tasks. Each step lists **five actionable items** to move the codebase toward readiness.

---

## 1) How this review was run

- Read-only inspection of the working tree (no network). 
- Tools: local file inspection; no commands beyond listing and reading files. 
- Evidence standard: findings cite file paths/line ranges and propose concrete owners/actions.

---

# STEP 1 — Repo Recon + Ceremony Alignment (READ-ONLY)

### Actionable items (5)
1) Publish a concise repo map in `README.md` covering major directories (e.g., `src/`, `configs/`, `docs/`, `tests/`, `runs/`) to reduce onboarding time beyond the current quickstart snippets. 
2) Add an "entry points" subsection to `README.md` summarizing `detectlab` CLI, `docs/runbook.md`, and `docs/getting_started.md` so first-time users know where to start. 
3) Consolidate the numerous `README__D-0024.*_BUNDLE.md` history bundles into a single index pointing to the latest authoritative guide. 
4) Add a short note in `README.md` on where artifacts are written (`runs/<RUN_ID>/...`) and which commands populate them, mirroring the smoke paths already documented. 
5) Capture the canonical location for code-freeze and RR rituals (e.g., link `CODE_FREEZE__CF-0004.md` and the restart prompt) in the repo map to keep ceremonies discoverable.

---

# STEP 2 — Correctness & Reliability

### Findings (high-signal)
- `detectlab doctor` is effectively a no-op (imports only) even though docs ask users to run it for quick verification. 
- Environment diagnostics live only inside `sanity`, so the advertised doctor path never emits the health data operators expect.

### Actionable items (5)
1) Implement the missing diagnostics in `doctor()` (Python/platform/dep versions, threadpools) and return non-zero on failures; mirror the probes already present in `sanity`. 
2) Extract a shared helper for environment probes used by both `doctor` and `sanity` to prevent future drift. 
3) Add a CLI test that asserts `detectlab doctor` prints expected keys (python/platform/pyarrow/sklearn) and exits 0 when deps are present. 
4) Gate `sanity --tiny-run` behind an explicit flag in CI to avoid unintended artifact writes while keeping compile/import checks on by default. 
5) Add a minimal config-validation test that exercises `_require_pyarrow()` via a lightweight CLI command (e.g., `detectlab dataset show-schema`) to ensure Parquet enforcement remains fail-closed.

---

# STEP 3 — Hygiene, Security, Dependencies

### Actionable items (5)
1) Introduce dependency locking (e.g., `requirements.txt` generated by `pip-tools`) to complement the loose lower bounds in `pyproject.toml` and stabilize CI environments. 
2) Add a dependency drift check (e.g., `pip check` or `python -m pip list --outdated` gate) to the release readiness script to catch mismatches early. 
3) Document a secrets scanning step (e.g., `gitleaks` or `detect-secrets`) in contributor guidance to prevent accidental commits. 
4) Add a cache-cleanup target (wrapping `detectlab cache prune`) to CI or developer make targets to prevent unbounded growth under `runs/_cache/features`. 
5) Publish a short "artifact retention" policy in docs (how long to keep `runs/` outputs, when to prune) so local and CI runs stay hygienic.

---

# STEP 4 — Documentation, DX, Observability

### Actionable items (5)
1) Update `docs/getting_started.md` quick verification to mention the expected `doctor` output (and failures) once fixed. 
2) Add a "first success path" checklist that chains `detectlab --help`, `detectlab doctor`, `detectlab sanity --no-tiny-run`, and the smoke run so new users can validate in 10–15 minutes. 
3) Link example artifacts (`runs/<RUN_ID>/reports/summary.md`, UI bundle path) directly from the smoke-run sections in `README.md` and `runbook`. 
4) Add troubleshooting tips for common failures (missing `pyarrow`, `threadpoolctl` warnings) near the quickstart sections to reduce support load. 
5) Provide a short observability note on how to inspect step logs/manifest files for a run (`runs/<RUN_ID>/manifest.json`), aligning with the cache and baseline commands already documented.

---

# STEP 5 — Architecture, Tests, CI Gates

### Actionable items (5)
1) Create a reusable diagnostics module (importable by CLI and tests) to centralize environment checks and reduce duplication between commands. 
2) Add a CI job that runs `python -m compileall src`, `pytest`, and `detectlab doctor` to guarantee importability and environment readiness on every commit. 
3) Define a minimal regression suite for the step runner (covering dataset → features → baselines → eval with `reuse_if_exists=True`) to protect the RR sanity path. 
4) Split the CLI module if it grows further (e.g., move command groups into `cli/*.py`) to keep `cli.py` maintainable and testable. 
5) Add acceptance criteria for RR: doctor passes, sanity (no tiny run) passes, smoke pipeline writes expected manifests, and UI bundle export succeeds.

---

## Step Completion Checklists
- Step 1: repo structure mapped and ceremony alignment tasks recorded (5/5 actions). 
- Step 2: correctness gaps identified with remediation tasks (5/5 actions). 
- Step 3: hygiene/security/dependency tasks captured (5/5 actions). 
- Step 4: docs/DX/observability improvements listed (5/5 actions). 
- Step 5: architecture/test/CI gates proposed (5/5 actions).

---

## Final Notes
- Primary blocker remains the non-functional `doctor` command and lack of automated guardrails; the actions above prioritize restoring diagnostics and wiring them into CI.
